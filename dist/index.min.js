!function(){var _,d,a,w;function y(t,e){var n,i={}.hasOwnProperty;for(n in e)i.call(e,n)&&(t[n]=e[n]);return t}function b(t,e){for(var n=-1,i=e.length>>>0;++n<i;)if(t===e[n])return!0;return!1}_=function(e,t,n){return e.node.addEventListener(t,function(t){return n(y({evt:t},e))})},d=function(t,e,n){return null!=n?t.querySelectorAll(e)[n]:Array.from(t.querySelectorAll(e))},a=function(t,e){return t.closest(e)},(w=function(t){var e,n,i,r,o,s,c,a,l,h,u=this;for(null==t&&(t={}),1<arguments.length&&(t=w.merge.apply(w,Array.from(arguments))),this.evtHandler={},this._ctxs=t.ctxs||null,this.views=[this].concat(t.baseViews||[]),this._ctx=t.context||t.ctx||null,t.context&&console.warn("[ldview] `context` is deprecated. use `ctx` instead."),this.attr=t.attr||{},this.style=t.style||{},this.handler=t.handler||{},this.action=t.action||{},this.text=t.text||{},this.initer=t.init||{},this.prefix=t.prefix,this.global=t.global||!1,this.ld=this.global?"pd":"ld",this.initRender=null==t.initRender||t.initRender,this.root="string"==typeof t.root?d(document,t.root,0):t.root,this.root||console.warn("[ldview] warning: no node found for root ",t.root),this.root.setAttribute&&!this.global&&(this.id="ld-"+Math.random().toString(36).substring(2),this.root.setAttribute("ld-scope-"+this.id,"")),(this.template=t.template)&&(this.root.textContent="",this.root.appendChild(this.template.cloneNode(!0))),this.update(),e={},n=0,s=(i=[function(){var t=[];for(r in this.initer)t.push(r);return t}.call(this)].concat([function(){var t=[];for(r in this.attr)t.push(r);return t}.call(this)],[function(){var t=[];for(r in this.style)t.push(r);return t}.call(this)],[function(){var t=[];for(r in this.text)t.push(r);return t}.call(this)],[function(){var t=[];for(r in this.handler)t.push(r);return t}.call(this)],function(){var t,e=[];for(r in t=this.action)o=t[r],e.push(o);return e}.call(this).map(function(t){var e,n=[];for(e in t)n.push(e);return n}))).length;n<s;++n)for(a=0,l=(c=i[n]).length;a<l;++a)e[c[a]]=!0;for(r in h=[],e)h.push(r);return this.names=h,this.initRender&&this.init().then(function(){return u.render()}),this}).prototype=y(Object.create(Object.prototype),{update:function(t){var e,n,i,r,o,s,c=this;if(null==t&&(t=this.root),this.nodes||(this.nodes=[]),this.eaches||(this.eaches=[]),this.map||(this.map={nodes:{},eaches:{}}),e=this.prefix?"["+this.ld+"-each^="+this.prefix+"\\$]":"["+this.ld+"-each]",n=this.global?[]:d(t,(this.id?"[ld-scope-"+this.id+"] ":"")+"[ld-scope] "+e),i=d(t,e),r=this.eaches.map(function(t){return t.n}),o=i.filter(function(t){return!b(t,n)}).filter(function(t){return!b(t,r)}).map(function(t){var e,n,i,r;return!t.parentNode||a(t.parentNode,"*["+c.ld+"-each]")?null:(e=t.getAttribute(c.ld+"-each"),c.handler[e]?(n=t.parentNode,i={idx:Array.from(n.childNodes).indexOf(t),node:t,name:e,nodes:[]},r=document.createComment(" "+c.ld+"-each="+e+" "),c.handler[e].host||n.insertBefore(r,t),n.removeChild(t),(r._data=i).proxy=r,i.container=(t=c.handler[e].host)?new t({root:n}):n,i):null)}).filter(function(t){return t}),this.eaches=this.eaches.concat(o),o.map(function(t){var e,n;return((e=c.map.eaches)[n=t.name]||(e[n]=[])).push(t)}),e=this.prefix?"["+this.ld+"^="+this.prefix+"\\$]":"["+this.ld+"]",n=this.global?[]:d(t,(this.id?"[ld-scope-"+this.id+"] ":"")+"[ld-scope] "+e),o=(i=d(t,e)).filter(function(t){return!(b(t,n)||b(t,c.nodes))}),this.nodes=this.nodes.concat(o),s=this.prefix?new RegExp("^"+this.prefix+"\\$"):null,o.map(function(n){var i=(n.getAttribute(c.ld)||"").split(" ");return(i=c.prefix?i.map(function(t){return t.replace(s,"").trim()}):i).map(function(t){var e;return((e=c.map.nodes)[t]||(e[t]=[])).push({node:n,names:i,local:{},evts:{}})})}),!this.map.nodes["@"])return this.map.nodes["@"]=[{node:this.root,names:"@",local:{},evts:{}}]},procEach:function(n,i,e,r){var o,s,c,a,l,t,h,u,d,f,p,x,m,v,_,w,y,g=this;for(null==e&&(e=null),y="function"==typeof this._ctx?this._ctx({node:this.root,ctxs:this._ctxs,views:this.views}):this._ctx,o=this.handler[n].list({name:i.name,node:i.node,views:this.views,context:y,ctx:y,ctxs:this._ctxs})||[],s=this.handler[n].key,c={},a=[],l=!!s,s?o.map(function(t){if("object"!=typeof(t=s(t)))return c[t]=(c[t]||0)+1}):s=function(t){return t},t=i.nodes.filter(function(t){return t}).map(function(t){var e=s(t._data);return"object"!=typeof e&&!l||"object"==typeof e&&!b(t._data,o)||l&&!c[e]?(i.container.removeChild(t),delete t._data):(a.push(e),l&&c[e]&&c[e]--),t}).filter(function(t){return null!=t._data}),(h=Array.from(i.container.childNodes).indexOf(i.proxy))<0&&(h=i.container.childNodes.length),u=[],d={},f=o.length-1;0<=f;--f)x=o[p=f],m=s(x),l&&"object"!=typeof m&&(d[m]=(d[m]||0)+1),0<=(v=a.indexOf(m))?(_=t[v],a.splice(v,1),t.splice(v,1),_._data=x,_._obj||(_._obj={node:_,name:n,idx:p,local:{}}),_._obj.data=x,Array.from(i.container.childNodes).indexOf(_)!==(w=h-(o.length-p))&&(i.container.removeChild(_),w=(h=(h=Array.from(i.container.childNodes).indexOf(i.proxy))<0?i.container.childNodes.length:h)-(o.length-p),i.container.insertBefore(_,i.container.childNodes[w+1]),h+=1),u.splice(0,0,_)):l&&"object"!=typeof m&&1<d[m]||((_=i.node.cloneNode(!0))._data=x,_._obj={node:_,name:n,data:x,idx:p,local:{}},_.removeAttribute(this.ld+"-each"),w=h-(o.length-p),i.container.insertBefore(_,i.container.childNodes[w+1]),h+=1,u.splice(0,0,_));return y=u.filter(function(t){return t}),y=(y=null!=e?y.filter(function(t){return b(s(t._obj.data),e)}):y).map(function(t,e){return g._render(n,t._obj,e,g.handler[n],!0,r)}),i.container.update&&i.container.update(),i.nodes=u,Promise.all(y)},get:function(t){return((this.map.nodes[t]||[])[0]||{}).node},getAll:function(t){return(this.map.nodes[t]||[]).map(function(t){return t.node})},_render:function(e,t,n,a,o,i){var r,s,c,l,h,u,d,f,p,x,m,v="function"==typeof this._ctx?this._ctx({node:this.root,ctxs:this._ctxs,views:this.views}):this._ctx;t.ctx=v,t.context=v,t.ctxs=this._ctxs,t.views=this.views,a?a.view?(r=function(t){var e,n=t.node,i=t.local,r=t.data,o=t.ctx,s=t.ctxs,t=t.views,c=y({ctx:r},a.view);return c.initRender=!1,c.root=n,c.baseViews=t,c.ctxs=s?[o].concat(s):[o],"function"==typeof(n=c).ctx&&(e=n.ctx,n.ctx=function(t){return e(y({ctx:r||o},t))},i._ctx=e),i._view=new w(n),i._view.init()},s=function(t){var e=t.local,n=t.data,i=t.ctx,r=t.ctxs;return o?e._view.ctx(n||i):e._ctx&&e._view.ctx(e._ctx((t.ctxs=[i].concat(r),t))),e._view.ctxs(r?[i].concat(r):[i]),e._view.render()}):(r=a.init||null,s=a.handler||a.handle||null,c=a.text||null,l=a.attr||null,h=a.style||null,u=a.action||{}):(r=(d=[this.initer[e],this.handler[e],this.attr[e],this.style[e],this.text[e],this.action])[0],s=d[1],l=d[2],h=d[3],c=d[4],u=d[5]);try{if(r&&!(t.inited||(t.inited={}))[e]&&(t.inited[e]=Promise.resolve(r(t)).then(function(){return t.inited[e]=!0})),i)return Promise.resolve((t.inited||(t.inited={}))[e]);if(f=[],s&&f.push(s(t)),c&&(t.node.textContent="function"==typeof c?c(t):c),l)for(p in d=l(t)||{})x=d[p],t.node.setAttribute(p,x);if(h)for(p in d=h(t)||{})x=d[p],t.node.style[p]=x;for(p in d=u||{})(x=d[p])&&(m=a?x:x[e])&&!(t.evts||(t.evts={}))[p]&&(_(t,p,m),t.evts[p]=!0);return Promise.all(f)}catch(t){throw o=t,console.warn("[ldview] failed when rendering "+e+":",o),o}},bindEachNode:function(t){var e=t.name,n=t.container,i=t.idx,t=t.node;if(e=this.map.eaches[e].filter(function(t){return t.container===n})[0])return null!=i?e.nodes.splice(i,0,t):e.nodes.push(t)},unbindEachNode:function(t){var e=t.name,n=t.container,i=t.idx,t=t.node;if(e=this.map.eaches[e].filter(function(t){return t.container===n})[0])return t&&!i&&(i=e.nodes.indexOf(t)),e.nodes.splice(i,1)},init:function(t){for(var e,n=[],i=1,r=arguments.length;i<r;++i)n.push(arguments[i]);return e=n,this._prerender("init",t,e)},render:function(t){for(var e,n=[],i=1,r=arguments.length;i<r;++i)n.push(arguments[i]);return e=n,this._prerender("render",t,e)},_prerender:function(t,e,n){var r,o,s=this,c="init"===t;return this.fire("beforeRender"),r=function(n){var t,e,i=[];return"object"==typeof n&&(t=[n.name,n.key],n=t[0],e=t[1],Array.isArray(e)||(e=[e])),s.map.nodes[n]&&(i=i.concat(s.map.nodes[n].map(function(t,e){return t.name=n,t.idx=e,s._render(n,t,e,"object"==typeof s.handler[n]?{view:s.handler[n]}:null,!1,c)}))),s.map.eaches[n]&&s.handler[n]&&(i=i.concat(s.map.eaches[n].map(function(t){return s.procEach(n,t,e,c)}))),Promise.all(i)},t=e?(Array.isArray(e)?e:[e]).concat(n).map(r):function(){for(var t,e=[],n=0,i=(t=this.names).length;n<i;++n)o=t[n],e.push(r(o));return e}.call(this),this.fire("afterRender"),Promise.all(t)},setContext:function(t){return console.warn("[ldview] `setContext` is deprecated. use `ctx(...)` instead."),this._ctx=t},setCtx:function(t){return console.warn("[ldview] `setCtx` is deprecated. use `ctx(...)` instead."),this._ctx=t},ctx:function(t){return arguments.length?this._ctx=t:this._ctx},ctxs:function(t){return arguments.length?this._ctxs=t:this._ctxs},on:function(t,e){var n;return((n=this.evtHandler)[t]||(n[t]=[])).push(e)},fire:function(t){for(var e,n,i,r,o=[],s=[],c=1,a=arguments.length;c<a;++c)s.push(arguments[c]);for(e=s,c=0,i=(n=this.evtHandler[t]||[]).length;c<i;++c)r=n[c],o.push(r.apply(this,e));return o}}),w.merge=function(){return w._merge.apply(w,[{}].concat(Array.from(arguments)))},w._merge=function(){var t,e,n,i,r,o=Array.from(arguments);if(o.length<2)return o[0];for(t=o.splice(0,1)[0],e=0,n=o.length;e<n;++e)for(r in i=o[e])null!=i[r]&&("object"==typeof i[r]&&i[r].constructor===Object?w._merge(t[r]||(t[r]={}),i[r]):t[r]=i[r]);return t},"undefined"!=typeof module&&null!==module&&(module.exports=w),"undefined"!=typeof window&&null!==window&&(window.ldView=window.ldview=w)}.call(this);
