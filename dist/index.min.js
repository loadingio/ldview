!function(){var w,_;function y(t,e){var n,i={}.hasOwnProperty;for(n in e)i.call(e,n)&&(t[n]=e[n]);return t}function g(t,e){for(var n=-1,i=e.length>>>0;++n<i;)if(t===e[n])return!0;return!1}w=function(e,t,n){return e.node.addEventListener(t,function(t){return n(y({evt:t},e))})},(_=function(t){var e,n,i,r,o,s,a,c,h,d,l=this;for(null==t&&(t={}),this.evtHandler={},this._ctxs=t.ctxs||null,this.views=[this].concat(t.baseViews||[]),this._ctx=t.context||t.ctx||null,t.context&&console.warn("[ldview] `context` is deprecated. use `ctx` instead."),this.attr=t.attr||{},this.style=t.style||{},this.handler=t.handler||{},this.action=t.action||{},this.text=t.text||{},this.initer=t.init||{},this.prefix=t.prefix,this.global=t.global||!1,this.ld=this.global?"pd":"ld",this.initRender=null==t.initRender||t.initRender,this.root="string"==typeof t.root?ld$.find(document,t.root,0):t.root,this.root||console.warn("[ldview] warning: no node found for root ",t.root),this.root.setAttribute&&!this.global&&(this.id="ld-"+Math.random().toString(36).substring(2),this.root.setAttribute("ld-scope-"+this.id,"")),(this.template=t.template)&&(this.root.textContent="",this.root.appendChild(this.template.cloneNode(!0))),this.update(),e={},n=0,s=(i=[function(){var t=[];for(r in this.initer)t.push(r);return t}.call(this)].concat([function(){var t=[];for(r in this.attr)t.push(r);return t}.call(this)],[function(){var t=[];for(r in this.style)t.push(r);return t}.call(this)],[function(){var t=[];for(r in this.text)t.push(r);return t}.call(this)],[function(){var t=[];for(r in this.handler)t.push(r);return t}.call(this)],function(){var t,e=[];for(r in t=this.action)o=t[r],e.push(o);return e}.call(this).map(function(t){var e,n=[];for(e in t)n.push(e);return n}))).length;n<s;++n)for(c=0,h=(a=i[n]).length;c<h;++c)e[a[c]]=!0;for(r in d=[],e)d.push(r);return this.names=d,this.initRender&&this.init().then(function(){return l.render()}),this}).prototype=y(Object.create(Object.prototype),{update:function(t){var e,n,i,r,o,s,a=this;if(null==t&&(t=this.root),this.nodes||(this.nodes=[]),this.eaches||(this.eaches=[]),this.map||(this.map={nodes:{},eaches:{}}),e=this.prefix?"["+this.ld+"-each^="+this.prefix+"\\$]":"["+this.ld+"-each]",n=this.global?[]:ld$.find(t,(this.id?"[ld-scope-"+this.id+"] ":"")+"[ld-scope] "+e),i=ld$.find(t,e),r=this.eaches.map(function(t){return t.n}),o=i.filter(function(t){return!g(t,n)}).filter(function(t){return!g(t,r)}).map(function(t){var e,n,i,r;if(!t.parentNode)return null;try{if(ld$.parent(t.parentNode,"*["+a.ld+"-each]"))return null}catch(t){0}return e=t.getAttribute(a.ld+"-each"),a.handler[e]?(n=t.parentNode,i={idx:Array.from(n.childNodes).indexOf(t),node:t,name:e,nodes:[]},r=document.createComment(" "+a.ld+"-each="+e+" "),a.handler[e].host||n.insertBefore(r,t),n.removeChild(t),(r._data=i).proxy=r,i.container=(t=a.handler[e].host)?new t({root:n}):n,i):null}).filter(function(t){return t}),this.eaches=this.eaches.concat(o),o.map(function(t){var e,n;return((e=a.map.eaches)[n=t.name]||(e[n]=[])).push(t)}),e=this.prefix?"["+this.ld+"^="+this.prefix+"\\$]":"["+this.ld+"]",n=this.global?[]:ld$.find(t,(this.id?"[ld-scope-"+this.id+"] ":"")+"[ld-scope] "+e),o=(i=ld$.find(t,e)).filter(function(t){return!(g(t,n)||g(t,a.nodes))}),this.nodes=this.nodes.concat(o),s=this.prefix?new RegExp("^"+this.prefix+"\\$"):null,o.map(function(n){var i=(n.getAttribute(a.ld)||"").split(" ");return(i=a.prefix?i.map(function(t){return t.replace(s,"").trim()}):i).map(function(t){var e;return((e=a.map.nodes)[t]||(e[t]=[])).push({node:n,names:i,local:{},evts:{}})})}),!this.map.nodes["@"])return this.map.nodes["@"]=[{node:this.root,names:"@",local:{},evts:{}}]},procEach:function(n,i,e,r){var o,s,a,c,t,h,d,l,u,f,p,x,v,m,w=this;for(null==e&&(e=null),m="function"==typeof this._ctx?this._ctx({node:this.root,ctxs:this._ctxs,views:this.views}):this._ctx,o=this.handler[n].list({name:i.name,node:i.node,views:this.views,context:m,ctx:m,ctxs:this._ctxs})||[],s=this.handler[n].key,a={},c=[],s?o.map(function(t){return a[s(t)]=t}):s=function(t){return t},t=i.nodes.filter(function(t){return t}).map(function(t){var e=s(t._data);return"object"!=typeof e&&!a[e]||"object"==typeof e&&!g(t._data,o)?(i.container.removeChild(t),t._data=null):c.push(e),t}).filter(function(t){return t._data}),(h=Array.from(i.container.childNodes).indexOf(i.proxy))<0&&(h=i.container.childNodes.length),d=[],l=o.length-1;0<=l;--l)f=o[u=l],0<=(p=c.indexOf(s(f)))?((x=t[p])._data=f,x._obj||(x._obj={node:x,name:n,idx:u,local:{}}),x._obj.data=f,Array.from(i.container.childNodes).indexOf(x)!==(v=h-(o.length-u))&&(i.container.removeChild(x),v=(h=(h=Array.from(i.container.childNodes).indexOf(i.proxy))<0?i.container.childNodes.length:h)-(o.length-u),i.container.insertBefore(x,i.container.childNodes[v+1]),h+=1)):((x=i.node.cloneNode(!0))._data=f,x._obj={node:x,name:n,data:f,idx:u,local:{}},x.removeAttribute(this.ld+"-each"),v=h-(o.length-u),i.container.insertBefore(x,i.container.childNodes[v+1]),h+=1),d.splice(0,0,x);return m=d.filter(function(t){return t}),m=(m=null!=e?m.filter(function(t){return g(s(t._obj.data),e)}):m).map(function(t,e){return w._render(n,t._obj,e,w.handler[n],!0,r)}),i.container.update&&i.container.update(),i.nodes=d,Promise.all(m)},get:function(t){return((this.map.nodes[t]||[])[0]||{}).node},getAll:function(t){return(this.map.nodes[t]||[]).map(function(t){return t.node})},_render:function(e,t,n,s,r,i){var o,a,c,h,d,l,u,f,p,x,v=[],m="function"==typeof this._ctx?this._ctx({node:this.root,ctxs:this._ctxs,views:this.views}):this._ctx;t.ctx=m,t.context=m,t.ctxs=this._ctxs,t.views=this.views,s?s.view?(o=function(t){var e=t.node,n=t.local,i=t.data,r=t.ctx,o=t.ctxs,t=t.views;return n._view=new _(((i=y({ctx:i},s.view)).initRender=!1,i.root=e,i.baseViews=t,i.ctxs=o?[r].concat(o):[r],i)),n._view.init()},a=function(t){var e=t.local,n=t.data,i=t.ctx,t=t.ctxs;return r&&e._view.ctx(n),e._view.ctxs(t?[i].concat(t):[i]),e._view.render()}):(o=s.init||null,a=s.handler||s.handle||null,c=s.text||null,h=s.attr||null,d=s.style||null,l=s.action||{}):(o=(u=[this.initer[e],this.handler[e],this.attr[e],this.style[e],this.text[e],this.action])[0],a=u[1],h=u[2],d=u[3],c=u[4],l=u[5]);try{if(o&&!(t.inited||(t.inited={}))[e]&&(t.inited[e]=Promise.resolve(o(t)).then(function(){return t.inited[e]=!0})),i)return Promise.resolve((t.inited||(t.inited={}))[e]);if(a&&a(t),c&&(t.node.textContent="function"==typeof c?c(t):c),h)for(f in u=h(t)||{})p=u[f],t.node.setAttribute(f,p);if(d)for(f in u=d(t)||{})p=u[f],t.node.style[f]=p;for(f in u=l||{})(p=u[f])&&(x=s?p:p[e])&&!(t.evts||(t.evts={}))[f]&&(w(t,f,x),v.push(t.evts[f]=!0));return v}catch(t){throw r=t,console.warn("[ldview] failed when rendering "+e+":",r),r}},bindEachNode:function(t){var e=t.name,n=t.container,i=t.idx,t=t.node;if(e=this.map.eaches[e].filter(function(t){return t.container===n})[0])return null!=i?e.nodes.splice(i,0,t):e.nodes.push(t)},unbindEachNode:function(t){var e=t.name,n=t.container,i=t.idx,t=t.node;if(e=this.map.eaches[e].filter(function(t){return t.container===n})[0])return t&&!i&&(i=e.nodes.indexOf(t)),e.nodes.splice(i,1)},init:function(t){for(var e,n=[],i=1,r=arguments.length;i<r;++i)n.push(arguments[i]);return e=n,this._prerender("init",t,e)},render:function(t){for(var e,n=[],i=1,r=arguments.length;i<r;++i)n.push(arguments[i]);return e=n,this._prerender("render",t,e)},_prerender:function(t,e,n){var r,o,s=this,a="init"===t;return this.fire("beforeRender"),r=function(n){var t,e,i=[];return"object"==typeof n&&(t=[n.name,n.key],n=t[0],e=t[1],Array.isArray(e)||(e=[e])),s.map.nodes[n]&&(i=i.concat(s.map.nodes[n].map(function(t,e){return t.name=n,t.idx=e,s._render(n,t,e,"object"==typeof s.handler[n]?{view:s.handler[n]}:null,!1,a)}))),s.map.eaches[n]&&s.handler[n]&&(i=i.concat(s.map.eaches[n].map(function(t){return s.procEach(n,t,e,a)}))),Promise.all(i)},t=e?(Array.isArray(e)?e:[e]).concat(n).map(r):function(){for(var t,e=[],n=0,i=(t=this.names).length;n<i;++n)o=t[n],e.push(r(o));return e}.call(this),this.fire("afterRender"),Promise.all(t)},setContext:function(t){return console.warn("[ldview] `setContext` is deprecated. use `ctx(...)` instead."),this._ctx=t},setCtx:function(t){return console.warn("[ldview] `setCtx` is deprecated. use `ctx(...)` instead."),this._ctx=t},ctx:function(t){return arguments.length?this._ctx=t:this._ctx},ctxs:function(t){return arguments.length?this._ctxs=t:this._ctxs},on:function(t,e){var n;return((n=this.evtHandler)[t]||(n[t]=[])).push(e)},fire:function(t){for(var e,n,i,r,o=[],s=[],a=1,c=arguments.length;a<c;++a)s.push(arguments[a]);for(e=s,a=0,i=(n=this.evtHandler[t]||[]).length;a<i;++a)r=n[a],o.push(r.apply(this,e));return o}}),"undefined"!=typeof module&&null!==module&&(module.exports=_),"undefined"!=typeof window&&null!==window&&(window.ldView=window.ldview=_)}.call(this);
