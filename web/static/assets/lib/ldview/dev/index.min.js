!function(){var w,u,y;function g(t,e){var n,i={}.hasOwnProperty;for(n in e)i.call(e,n)&&(t[n]=e[n]);return t}function b(t,e){for(var n=-1,i=e.length>>>0;++n<i;)if(t===e[n])return!0;return!1}w=function(e,t,n){return e.node.addEventListener(t,function(t){return n(g({evt:t},e))})},u="undefined"!=typeof module&&null!==module&&"undefined"!=typeof require&&null!==require?require("./ldreactive.js"):"undefined"!=typeof window&&null!==window?window.ldreactive:void 0,(y=function(t){var e,n,i,r,o,s,a,c,h,l,d=this;for(null==t&&(t={}),1<arguments.length&&(t=y.merge.apply(y,Array.from(arguments))),this.evtHandler={},this._ctxs=t.ctxs||null,this.views=[this].concat(t.baseViews||[]),this._ctx=t.context||t.ctx||null,t.context&&console.warn("[ldview] `context` is deprecated. use `ctx` instead."),this._reactive=null,this._reactiveEnabled=!1,this._ctx&&u&&(this._ctx instanceof u||this._ctx._isReactiveContext)&&(this._reactive=this._ctx,this._reactiveEnabled=!0,this._reactive.on("change",function(t,e,n,i){if(i&&0<i.length)return d.render(i)})),this.attr=t.attr||{},this.style=t.style||{},this.handler=t.handler||{},this.action=t.action||{},this.text=t.text||{},this.initer=t.init||{},this.prefix=t.prefix,this.global=t.global||!1,this.ld=this.global?"pd":"ld",this.initRender=null==t.initRender||t.initRender,this.root="string"==typeof t.root?ld$.find(document,t.root,0):t.root,this.root||console.warn("[ldview] warning: no node found for root ",t.root),this.root.setAttribute&&!this.global&&(this.id="ld-"+Math.random().toString(36).substring(2),this.root.setAttribute("ld-scope-"+this.id,"")),(this.template=t.template)&&(this.root.textContent="",this.root.appendChild(this.template.cloneNode(!0))),this.update(),e={},n=0,s=(i=[function(){var t=[];for(r in this.initer)t.push(r);return t}.call(this)].concat([function(){var t=[];for(r in this.attr)t.push(r);return t}.call(this)],[function(){var t=[];for(r in this.style)t.push(r);return t}.call(this)],[function(){var t=[];for(r in this.text)t.push(r);return t}.call(this)],[function(){var t=[];for(r in this.handler)t.push(r);return t}.call(this)],function(){var t,e=[];for(r in t=this.action)o=t[r],e.push(o);return e}.call(this).map(function(t){var e,n=[];for(e in t)n.push(e);return n}))).length;n<s;++n)for(c=0,h=(a=i[n]).length;c<h;++c)e[a[c]]=!0;for(r in l=[],e)l.push(r);return this.names=l,this.initRender&&this.init().then(function(){return d.render()}),this}).prototype=g(Object.create(Object.prototype),{update:function(t){var e,n,i,r,o,s,a=this;if(null==t&&(t=this.root),this.nodes||(this.nodes=[]),this.eaches||(this.eaches=[]),this.map||(this.map={nodes:{},eaches:{}}),e=this.prefix?"["+this.ld+"-each^="+this.prefix+"\\$]":"["+this.ld+"-each]",n=this.global?[]:ld$.find(t,(this.id?"[ld-scope-"+this.id+"] ":"")+"[ld-scope] "+e),i=ld$.find(t,e),r=this.eaches.map(function(t){return t.n}),o=i.filter(function(t){return!b(t,n)}).filter(function(t){return!b(t,r)}).map(function(t){var e,n,i,r;if(!t.parentNode)return null;try{if(ld$.parent(t.parentNode,"*["+a.ld+"-each]"))return null}catch(t){0}return e=t.getAttribute(a.ld+"-each"),a.handler[e]?(n=t.parentNode,i={idx:Array.from(n.childNodes).indexOf(t),node:t,name:e,nodes:[]},r=document.createComment(" "+a.ld+"-each="+e+" "),a.handler[e].host||n.insertBefore(r,t),n.removeChild(t),(r._data=i).proxy=r,i.container=(t=a.handler[e].host)?new t({root:n}):n,i):null}).filter(function(t){return t}),this.eaches=this.eaches.concat(o),o.map(function(t){var e,n;return((e=a.map.eaches)[n=t.name]||(e[n]=[])).push(t)}),e=this.prefix?"["+this.ld+"^="+this.prefix+"\\$]":"["+this.ld+"]",n=this.global?[]:ld$.find(t,(this.id?"[ld-scope-"+this.id+"] ":"")+"[ld-scope] "+e),o=(i=ld$.find(t,e)).filter(function(t){return!(b(t,n)||b(t,a.nodes))}),this.nodes=this.nodes.concat(o),s=this.prefix?new RegExp("^"+this.prefix+"\\$"):null,o.map(function(n){var i=(n.getAttribute(a.ld)||"").split(" ");return(i=a.prefix?i.map(function(t){return t.replace(s,"").trim()}):i).map(function(t){var e;return((e=a.map.nodes)[t]||(e[t]=[])).push({node:n,names:i,local:{},evts:{}})})}),!this.map.nodes["@"])return this.map.nodes["@"]=[{node:this.root,names:"@",local:{},evts:{}}]},procEach:function(n,i,e,r){var o,s,a,c,h,t,l,d,u,f,p,v,x,m,_,w,y,g=this;for(null==e&&(e=null),y="function"==typeof this._ctx?this._ctx({node:this.root,ctxs:this._ctxs,views:this.views}):this._ctx,o=this.handler[n].list({name:i.name,node:i.node,views:this.views,context:y,ctx:y,ctxs:this._ctxs})||[],s=this.handler[n].key,a={},c=[],h=!!s,s?o.map(function(t){if("object"!=typeof(t=s(t)))return a[t]=(a[t]||0)+1}):s=function(t){return t},t=i.nodes.filter(function(t){return t}).map(function(t){var e=s(t._data);return"object"!=typeof e&&!h||"object"==typeof e&&!b(t._data,o)||h&&!a[e]?(i.container.removeChild(t),delete t._data):(c.push(e),h&&a[e]&&a[e]--),t}).filter(function(t){return null!=t._data}),(l=Array.from(i.container.childNodes).indexOf(i.proxy))<0&&(l=i.container.childNodes.length),d=[],u={},f=o.length-1;0<=f;--f)v=o[p=f],x=s(v),h&&"object"!=typeof x&&(u[x]=(u[x]||0)+1),0<=(m=c.indexOf(x))?(_=t[m],c.splice(m,1),t.splice(m,1),_._data=v,_._obj||(_._obj={node:_,name:n,idx:p,local:{}}),_._obj.data=v,Array.from(i.container.childNodes).indexOf(_)!==(w=l-(o.length-p))&&(i.container.removeChild(_),w=(l=(l=Array.from(i.container.childNodes).indexOf(i.proxy))<0?i.container.childNodes.length:l)-(o.length-p),i.container.insertBefore(_,i.container.childNodes[w+1]),l+=1),d.splice(0,0,_)):h&&"object"!=typeof x&&1<u[x]||((_=i.node.cloneNode(!0))._data=v,_._obj={node:_,name:n,data:v,idx:p,local:{}},_.removeAttribute(this.ld+"-each"),w=l-(o.length-p),i.container.insertBefore(_,i.container.childNodes[w+1]),l+=1,d.splice(0,0,_));return y=d.filter(function(t){return t}),y=(y=null!=e?y.filter(function(t){return b(s(t._obj.data),e)}):y).map(function(t,e){return g._render(n,t._obj,e,g.handler[n],!0,r)}),i.container.update&&i.container.update(),i.nodes=d,Promise.all(y)},get:function(t){return((this.map.nodes[t]||[])[0]||{}).node},getAll:function(t){return(this.map.nodes[t]||[]).map(function(t){return t.node})},_render:function(e,t,n,s,r,i){var o,a,c,h,l,d,u,f,p,v,x,m=[],_=this._reactiveEnabled?this._reactive.get():"function"==typeof this._ctx?this._ctx({node:this.root,ctxs:this._ctxs,views:this.views}):this._ctx;t.ctx=_,t.context=_,t.ctxs=this._ctxs,t.views=this.views,_=this._reactiveEnabled,s&&void 0!==s.reactive&&(_=s.reactive),s?s.view?(o=function(t){var e=t.node,n=t.local,i=t.data,r=t.ctx,o=t.ctxs,t=t.views;return n._view=new y(((i=g({ctx:i},s.view)).initRender=!1,i.root=e,i.baseViews=t,i.ctxs=o?[r].concat(o):[r],i)),n._view.init()},a=function(t){var e=t.local,n=t.data,i=t.ctx,t=t.ctxs;return r&&e._view.ctx(n),e._view.ctxs(t?[i].concat(t):[i]),e._view.render()}):(o=s.init||null,a=s.handler||s.handle||null,c=s.text||null,h=s.attr||null,l=s.style||null,d=s.action||{}):(o=(u=[this.initer[e],this.handler[e],this.attr[e],this.style[e],this.text[e],this.action])[0],a=u[1],h=u[2],l=u[3],c=u[4],d=u[5]);try{if(o&&!(t.inited||(t.inited={}))[e]&&(t.inited[e]=Promise.resolve(o(t)).then(function(){return t.inited[e]=!0})),i)return Promise.resolve((t.inited||(t.inited={}))[e]);if(a&&(_&&this._reactive?this._reactive.track(e,function(){return a(t)}):a(t)),c&&(f="function"==typeof c?_&&this._reactive?this._reactive.track(e,function(){return c(t)}):c(t):c,t.node.textContent=f),h)for(p in u=(_&&this._reactive?this._reactive.track(e,function(){return h(t)}):h(t))||{})v=u[p],t.node.setAttribute(p,v);if(l)for(p in u=(_&&this._reactive?this._reactive.track(e,function(){return l(t)}):l(t))||{})v=u[p],t.node.style[p]=v;for(p in u=d||{})(v=u[p])&&(x=s?v:v[e])&&!(t.evts||(t.evts={}))[p]&&(w(t,p,x),m.push(t.evts[p]=!0));return m}catch(t){throw r=t,console.warn("[ldview] failed when rendering "+e+":",r),r}},bindEachNode:function(t){var e=t.name,n=t.container,i=t.idx,t=t.node;if(e=this.map.eaches[e].filter(function(t){return t.container===n})[0])return null!=i?e.nodes.splice(i,0,t):e.nodes.push(t)},unbindEachNode:function(t){var e=t.name,n=t.container,i=t.idx,t=t.node;if(e=this.map.eaches[e].filter(function(t){return t.container===n})[0])return t&&!i&&(i=e.nodes.indexOf(t)),e.nodes.splice(i,1)},init:function(t){for(var e,n=[],i=1,r=arguments.length;i<r;++i)n.push(arguments[i]);return e=n,this._prerender("init",t,e)},render:function(t){for(var e,n=[],i=1,r=arguments.length;i<r;++i)n.push(arguments[i]);return e=n,this._prerender("render",t,e)},_prerender:function(t,e,n){var r,o,s=this,a="init"===t;return this.fire("beforeRender"),r=function(n){var t,e,i=[];return"object"==typeof n&&(t=[n.name,n.key],n=t[0],e=t[1],Array.isArray(e)||(e=[e])),s.map.nodes[n]&&(i=i.concat(s.map.nodes[n].map(function(t,e){return t.name=n,t.idx=e,s._render(n,t,e,"object"==typeof s.handler[n]?{view:s.handler[n]}:null,!1,a)}))),s.map.eaches[n]&&s.handler[n]&&(i=i.concat(s.map.eaches[n].map(function(t){return s.procEach(n,t,e,a)}))),Promise.all(i)},t=e?(Array.isArray(e)?e:[e]).concat(n).map(r):function(){for(var t,e=[],n=0,i=(t=this.names).length;n<i;++n)o=t[n],e.push(r(o));return e}.call(this),this.fire("afterRender"),Promise.all(t)},setContext:function(t){return console.warn("[ldview] `setContext` is deprecated. use `ctx(...)` instead."),this._ctx=t},setCtx:function(t){return console.warn("[ldview] `setCtx` is deprecated. use `ctx(...)` instead."),this._ctx=t},ctx:function(t){return arguments.length?this._ctx=t:this._ctx},ctxs:function(t){return arguments.length?this._ctxs=t:this._ctxs},on:function(t,e){var n;return((n=this.evtHandler)[t]||(n[t]=[])).push(e)},fire:function(t){for(var e,n,i,r,o=[],s=[],a=1,c=arguments.length;a<c;++a)s.push(arguments[a]);for(e=s,a=0,i=(n=this.evtHandler[t]||[]).length;a<i;++a)r=n[a],o.push(r.apply(this,e));return o}}),y.merge=function(){return y._merge.apply(y,[{}].concat(Array.from(arguments)))},y._merge=function(){var t,e,n,i,r,o=Array.from(arguments);if(o.length<2)return o[0];for(t=o.splice(0,1)[0],e=0,n=o.length;e<n;++e)for(r in i=o[e])i[r]&&("object"==typeof i[r]&&i[r].constructor===Object?y._merge(t[r]||(t[r]={}),i[r]):t[r]=i[r]);return t},u&&(y.reactive=u),"undefined"!=typeof module&&null!==module&&(module.exports=y),"undefined"!=typeof window&&null!==window&&(window.ldView=window.ldview=y)}.call(this);
